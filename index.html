<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vibe - Market Sentiment Tracker</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: white; overflow: hidden; }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5); }
        .gradient-text { background: linear-gradient(to right, #ef4444, #8b5cf6, #10b981); -webkit-background-clip: text; color: transparent; }
        
        /* Animation Classes */
        .slide-out-left { animation: slideOutLeft 0.5s forwards; }
        .slide-out-right { animation: slideOutRight 0.5s forwards; }
        
        @keyframes slideOutLeft {
            to { transform: translateX(-150%) rotate(-20deg); opacity: 0; }
        }
        @keyframes slideOutRight {
            to { transform: translateX(150%) rotate(20deg); opacity: 0; }
        }

        /* Hide Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Loader */
        .loader { border: 4px solid #1e293b; border-top: 4px solid #8b5cf6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen w-screen flex flex-col">

    <div id="app" class="h-full w-full max-w-md mx-auto relative flex flex-col bg-slate-900">
        
        <header v-if="session" class="h-14 px-4 flex items-center justify-between border-b border-slate-800 z-20 bg-slate-900">
            <div @click="changeView('leaderboard')" class="text-xs font-bold text-slate-400 cursor-pointer hover:text-white transition">
                <i class="fa-solid fa-fire text-orange-500 mr-1"></i>HOT LIST
            </div>
            <div @click="changeView('swipe')" class="text-2xl font-black italic tracking-tighter cursor-pointer gradient-text">
                VIBE.
            </div>
            <div @click="changeView('profile')" class="h-8 w-8 rounded-full bg-slate-700 overflow-hidden border border-slate-600 cursor-pointer">
                <img v-if="profile?.avatar_url" :src="profile.avatar_url" class="w-full h-full object-cover" crossorigin="anonymous">
                <div v-else class="w-full h-full flex items-center justify-center text-xs">ðŸ‘¤</div>
            </div>
        </header>

        <main class="flex-1 relative overflow-hidden">
            
            <div v-if="!session" class="absolute inset-0 flex flex-col justify-center items-center p-8 z-50 bg-slate-900">
                <h1 class="text-6xl font-black italic mb-2 gradient-text">VIBE.</h1>
                <p class="text-slate-400 mb-8">Swipe on the Market.</p>
                
                <div class="w-full space-y-4">
                    <input v-model="authEmail" type="email" placeholder="Email" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-4 text-white placeholder-slate-500 focus:outline-none focus:border-purple-500 transition">
                    <input v-model="authPass" type="password" placeholder="Password" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-4 text-white placeholder-slate-500 focus:outline-none focus:border-purple-500 transition">
                    
                    <button @click="handleAuth" :disabled="loading" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 rounded-lg transition flex justify-center">
                        <span v-if="loading" class="loader"></span>
                        <span v-else>{{ isSignUp ? 'Create Account' : 'Sign In' }}</span>
                    </button>
                    
                    <p @click="isSignUp = !isSignUp" class="text-center text-sm text-slate-500 cursor-pointer mt-4 hover:text-white">
                        {{ isSignUp ? 'Already have an account? Sign In' : 'New here? Create Account' }}
                    </p>
                    <p v-if="authMsg" class="text-center text-sm text-red-400 mt-2">{{ authMsg }}</p>
                </div>
            </div>

            <div v-if="session && currentView === 'swipe'" class="absolute inset-0 flex flex-col items-center justify-center p-4">
                
                <div v-if="loadingCards" class="text-center">
                    <div class="loader mx-auto mb-4"></div>
                    <p class="text-slate-500 animate-pulse">Scanning market...</p>
                </div>

                <div v-else-if="cards.length === 0" class="text-center p-8">
                    <div class="text-6xl mb-4">ðŸ˜´</div>
                    <h2 class="text-2xl font-bold mb-2">All Caught Up!</h2>
                    <p class="text-slate-400 mb-6">No new trades to judge right now.</p>
                    <button @click="changeView('post')" class="bg-purple-600 text-white px-8 py-3 rounded-full font-bold shadow-lg shadow-purple-900/50">
                        Post Your Trade
                    </button>
                </div>

                <div v-else class="relative w-full h-[65vh] max-w-sm">
                    <div v-if="cards.length > 1" class="absolute top-4 left-0 w-full h-full bg-slate-800 rounded-3xl transform scale-95 opacity-50 -z-10"></div>
                    
                    <div :class="['absolute w-full h-full bg-slate-800 rounded-3xl border border-slate-700 p-6 flex flex-col justify-between card-shadow transition-transform duration-300', swipeAnimation]" style="will-change: transform">
                        
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-slate-700 overflow-hidden">
                                    <img :src="currentCard.profiles?.avatar_url || `https://api.dicebear.com/7.x/micah/svg?seed=${currentCard.user_id}`" class="w-full h-full object-cover">
                                </div>
                                <div>
                                    <p class="font-bold text-sm text-white">{{ currentCard.profiles?.username || 'Trader' }}</p>
                                    <p class="text-xs text-slate-400">{{ formatDate(currentCard.created_at) }}</p>
                                </div>
                            </div>
                            <button @click="prepareShare(currentCard, 'card')" class="text-slate-500 hover:text-white">
                                <i class="fa-solid fa-share-nodes"></i>
                            </button>
                        </div>

                        <div class="text-center my-4">
                            <div class="inline-block px-3 py-1 rounded-full text-xs font-black mb-2 tracking-wider"
                                 :class="currentCard.type === 'BUY' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'">
                                {{ currentCard.type }} ðŸš€
                            </div>
                            <h1 class="text-6xl font-black mb-1">{{ currentCard.ticker }}</h1>
                            <div class="text-3xl font-bold text-white">${{ currentCard.price }}</div>
                            <div class="text-sm text-slate-400 mt-2">{{ currentCard.shares }} Shares</div>
                            
                            <div class="mt-4 flex justify-center">
                                <span v-if="currentCard.verified" class="flex items-center gap-1 text-xs text-blue-400 bg-blue-400/10 px-2 py-1 rounded border border-blue-400/20">
                                    <i class="fa-solid fa-check-circle"></i> VERIFIED PRICE
                                </span>
                                <span v-else class="flex items-center gap-1 text-xs text-orange-400 bg-orange-400/10 px-2 py-1 rounded border border-orange-400/20">
                                    <i class="fa-solid fa-triangle-exclamation"></i> UNVERIFIED
                                </span>
                            </div>
                        </div>

                        <div class="flex justify-between text-xs text-slate-500 border-t border-slate-700 pt-4">
                            <span>Likes: {{ currentCard.likes }}</span>
                            <span>Dislikes: {{ currentCard.dislikes }}</span>
                        </div>
                    </div>
                </div>

                <div v-if="cards.length > 0" class="absolute bottom-8 flex items-center gap-6 z-20">
                    <button @click="swipe('NOPE')" class="w-16 h-16 rounded-full bg-slate-800 border-2 border-red-500 text-red-500 text-2xl shadow-lg flex items-center justify-center hover:bg-red-500 hover:text-white transition active:scale-95">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                    
                    <button @click="changeView('post')" class="w-12 h-12 rounded-full bg-slate-700 text-white text-xl flex items-center justify-center hover:bg-slate-600 transition">
                        <i class="fa-solid fa-plus"></i>
                    </button>

                    <button @click="swipe('LIKE')" class="w-16 h-16 rounded-full bg-slate-800 border-2 border-green-500 text-green-500 text-2xl shadow-lg flex items-center justify-center hover:bg-green-500 hover:text-white transition active:scale-95">
                        <i class="fa-solid fa-heart"></i>
                    </button>
                </div>
            </div>

            <div v-if="session && currentView === 'post'" class="absolute inset-0 bg-slate-900 p-6 flex flex-col animate-fade-in z-40">
                <div class="flex items-center justify-between mb-8">
                    <button @click="changeView('swipe')" class="text-slate-400 text-lg"><i class="fa-solid fa-arrow-left"></i></button>
                    <h2 class="font-bold text-lg">New Trade</h2>
                    <div class="w-6"></div>
                </div>

                <div class="space-y-6">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">TICKER</label>
                        <input v-model="form.ticker" @input="form.ticker = form.ticker.toUpperCase()" type="text" placeholder="e.g. NVDA" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-4 text-xl font-black text-white focus:border-purple-500 focus:outline-none uppercase">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">PRICE ($)</label>
                            <input v-model.number="form.price" type="number" step="0.01" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-4 text-white font-bold focus:border-purple-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">SHARES</label>
                            <input v-model.number="form.shares" type="number" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-4 text-white font-bold focus:border-purple-500 focus:outline-none">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">VIBE</label>
                        <select v-model="form.type" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-4 text-white font-bold focus:border-purple-500 focus:outline-none appearance-none">
                            <option value="BUY">ðŸš€ BUY (Bullish)</option>
                            <option value="SELL">ðŸ’€ SELL (Bearish)</option>
                        </select>
                    </div>

                    <div v-if="postError" class="text-red-400 text-sm text-center">{{ postError }}</div>

                    <button @click="submitTrade" :disabled="isPosting" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 rounded-lg mt-4 flex justify-center items-center gap-2">
                        <span v-if="isPosting" class="loader w-5 h-5 border-white border-t-transparent"></span>
                        <span v-else>Post to Board</span>
                    </button>
                </div>
            </div>

            <div v-if="session && currentView === 'leaderboard'" class="absolute inset-0 bg-slate-900 z-40 flex flex-col">
                <div class="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-900">
                    <button @click="changeView('swipe')" class="text-slate-400"><i class="fa-solid fa-arrow-left"></i></button>
                    <div class="flex gap-4">
                        <button @click="leaderboardTab = 'diamond'" :class="leaderboardTab === 'diamond' ? 'text-white font-bold' : 'text-slate-500'">DIAMOND</button>
                        <button @click="leaderboardTab = 'paper'" :class="leaderboardTab === 'paper' ? 'text-white font-bold' : 'text-slate-500'">PAPER</button>
                    </div>
                    <button @click="prepareShare(null, 'leaderboard')" class="text-slate-400"><i class="fa-solid fa-share-nodes"></i></button>
                </div>

                <div class="flex-1 overflow-y-auto p-4 no-scrollbar">
                    <div v-for="(item, index) in (leaderboardTab === 'diamond' ? leaderboard.diamond : leaderboard.paper)" :key="item.id" class="flex items-center justify-between py-4 border-b border-slate-800">
                        <div class="flex items-center gap-4">
                            <span class="font-black text-slate-600 text-lg w-6">#{{ index + 1 }}</span>
                            <div>
                                <h3 class="font-bold text-white">{{ item.ticker }} <span class="text-xs font-normal text-slate-400">by {{ item.profiles?.username }}</span></h3>
                                <p class="text-xs" :class="item.type === 'BUY' ? 'text-green-500' : 'text-red-500'">{{ item.type }} @ ${{ item.price }}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-lg">{{ leaderboardTab === 'diamond' ? item.likes : item.dislikes }}</div>
                            <div class="text-xs text-slate-500">{{ leaderboardTab === 'diamond' ? 'Likes' : 'Dislikes' }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="session && currentView === 'profile'" class="absolute inset-0 bg-slate-900 z-40 flex flex-col p-6 overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <button @click="changeView('swipe')" class="text-slate-400"><i class="fa-solid fa-arrow-left"></i></button>
                    <button @click="handleSignOut" class="text-sm text-red-400">Sign Out</button>
                </div>

                <div class="flex flex-col items-center mb-8">
                    <div class="relative group">
                        <div class="w-24 h-24 rounded-full bg-slate-700 overflow-hidden mb-4 border-2 border-purple-500">
                            <img :src="profile?.avatar_url || `https://api.dicebear.com/7.x/micah/svg?seed=${user?.id}`" class="w-full h-full object-cover">
                        </div>
                        <button @click="randomizeAvatar" class="absolute bottom-4 right-0 bg-slate-800 p-2 rounded-full border border-slate-600 text-xs"><i class="fa-solid fa-dice"></i></button>
                    </div>
                    <div class="flex items-center gap-2">
                        <h2 v-if="!editingName" class="text-xl font-bold">{{ profile?.username }}</h2>
                        <input v-else v-model="tempName" class="bg-transparent border-b border-purple-500 text-center text-xl font-bold w-32 focus:outline-none">
                        <button @click="toggleEditName" class="text-slate-500 text-xs"><i class="fa-solid" :class="editingName ? 'fa-check text-green-500' : 'fa-pen'"></i></button>
                    </div>
                    <p class="text-slate-500 text-sm">Member since 2025</p>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-8">
                    <div class="bg-slate-800 p-4 rounded-xl text-center">
                        <div class="text-2xl font-black text-white">{{ myTrades.length }}</div>
                        <div class="text-xs text-slate-400">POSTS</div>
                    </div>
                    <div class="bg-slate-800 p-4 rounded-xl text-center">
                        <div class="text-2xl font-black text-white">{{ totalLikes }}</div>
                        <div class="text-xs text-slate-400">LIKES RECEIVED</div>
                    </div>
                </div>

                <button @click="prepareShare(null, 'profile')" class="w-full bg-slate-800 border border-slate-700 py-3 rounded-lg mb-8 text-sm font-bold hover:bg-slate-700">
                    <i class="fa-solid fa-share-nodes mr-2"></i> Share Stat Card
                </button>

                <h3 class="font-bold text-slate-400 mb-4 text-sm uppercase">My History</h3>
                <div class="space-y-4 pb-10">
                    <div v-for="trade in myTrades" :key="trade.id" class="flex justify-between items-center bg-slate-800/50 p-4 rounded-lg">
                        <div>
                            <span class="font-bold">{{ trade.ticker }}</span>
                            <span :class="trade.type === 'BUY' ? 'text-green-500' : 'text-red-500'" class="text-xs ml-2 font-bold">{{ trade.type }}</span>
                            <div class="text-xs text-slate-500 mt-1">{{ formatDate(trade.created_at) }}</div>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-xs text-slate-400">{{ trade.likes }} <i class="fa-solid fa-heart text-xs"></i></span>
                            <button @click="deleteTrade(trade.id)" class="text-slate-600 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="showShareModal" class="absolute inset-0 z-[60] bg-black/90 flex flex-col items-center justify-center p-4">
                <div class="text-white font-bold mb-4">Sharing...</div>
                
                <div id="share-capture" class="bg-slate-900 p-6 rounded-3xl w-full max-w-[320px] border border-slate-700 relative overflow-hidden flex flex-col items-center text-center">
                    
                    <div class="mb-6 relative z-10 w-full">
                        <div class="text-2xl font-black italic gradient-text mb-4 text-left">VIBE.</div>
                        
                        <div v-if="shareType === 'card' && shareData">
                            <div class="w-20 h-20 mx-auto rounded-full bg-slate-700 overflow-hidden mb-2 border-2" :class="shareData.type === 'BUY' ? 'border-green-500' : 'border-red-500'">
                                <img :src="shareData.profiles?.avatar_url || `https://api.dicebear.com/7.x/micah/svg?seed=${shareData.user_id}`" class="w-full h-full object-cover">
                            </div>
                            <div class="text-sm font-bold mb-4">@{{ shareData.profiles?.username }}</div>
                            <div class="text-5xl font-black mb-1">{{ shareData.ticker }}</div>
                            <div class="text-xl font-bold" :class="shareData.type === 'BUY' ? 'text-green-500' : 'text-red-500'">
                                {{ shareData.type }}ing @ ${{ shareData.price }}
                            </div>
                            <p class="text-slate-400 text-xs mt-4 italic">"Bull or Bear? Who's with me?"</p>
                        </div>

                        <div v-if="shareType === 'leaderboard'">
                            <h3 class="text-xl font-bold mb-2 text-white">Market Movers</h3>
                            <div class="space-y-2 text-left bg-slate-800 p-3 rounded-lg">
                                <div v-for="(item, i) in (leaderboardTab === 'diamond' ? leaderboard.diamond : leaderboard.paper).slice(0,3)" class="flex justify-between text-xs">
                                    <span class="text-slate-300">#{{i+1}} {{item.ticker}}</span>
                                    <span class="font-bold text-white">{{ leaderboardTab==='diamond'?item.likes:item.dislikes }} Votes</span>
                                </div>
                            </div>
                            <p class="text-slate-400 text-xs mt-4 italic">"The official Diamond vs Paper list."</p>
                        </div>

                        <div v-if="shareType === 'profile'">
                            <div class="w-20 h-20 mx-auto rounded-full bg-slate-700 overflow-hidden mb-2">
                                <img :src="profile?.avatar_url" class="w-full h-full object-cover">
                            </div>
                            <h2 class="text-2xl font-bold">{{ profile?.username }}</h2>
                            <div class="grid grid-cols-2 gap-2 mt-4">
                                <div class="bg-slate-800 p-2 rounded">
                                    <div class="font-black">{{ myTrades.length }}</div>
                                    <div class="text-[10px] text-slate-400">TRADES</div>
                                </div>
                                <div class="bg-slate-800 p-2 rounded">
                                    <div class="font-black">{{ totalLikes }}</div>
                                    <div class="text-[10px] text-slate-400">LIKES</div>
                                </div>
                            </div>
                            <p class="text-slate-400 text-xs mt-4 italic">"Check my track record on Vibe!"</p>
                        </div>
                    </div>

                    <div class="mt-2 w-full flex flex-col items-center border-t border-slate-800 pt-4">
                        <div id="qrcode" class="bg-white p-1 rounded mb-1"></div>
                        <p class="text-[10px] font-bold tracking-widest text-slate-500">SCAN TO JOIN</p>
                    </div>
                </div>

                <div v-if="generatedImage" class="absolute inset-0 bg-black flex flex-col items-center justify-center p-4 z-20">
                    <p class="text-green-400 mb-2 text-sm"><i class="fa-solid fa-check"></i> Image Generated!</p>
                    <img :src="generatedImage" class="w-full max-w-[300px] rounded-xl shadow-2xl border border-slate-700">
                    <p class="text-slate-500 text-xs mt-4 text-center">Long press image to save/share</p>
                    <button @click="closeShare" class="mt-6 bg-slate-800 px-6 py-2 rounded-full text-sm">Close</button>
                </div>
            </div>

        </main>
    </div>

    <script>
        const { createClient } = supabase;

        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://iyqjrclnoftxarefqqls.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5cWpyY2xub2Z0eGFyZWZxcWxzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNzgwNDAsImV4cCI6MjA4MTY1NDA0MH0.sW9i7GkMaaDoFL27jEGEcw_2Dqh2zqrGiYas2cHwyQ8';
        const FINNHUB_KEY = 'd4ttplhr01qk9ur8sgrgd4ttplhr01qk9ur8sgs0';

        const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const app = Vue.createApp({
            data() {
                return {
                    session: null,
                    user: null,
                    profile: null,
                    currentView: 'auth', // auth, swipe, post, leaderboard, profile
                    
                    // Auth
                    authEmail: '',
                    authPass: '',
                    isSignUp: false,
                    loading: false,
                    authMsg: '',
                    
                    // Swipe
                    cards: [],
                    loadingCards: false,
                    swipeAnimation: '',
                    
                    // Post
                    form: { ticker: '', price: null, shares: null, type: 'BUY' },
                    isPosting: false,
                    postError: '',
                    
                    // Leaderboard
                    leaderboard: { diamond: [], paper: [] },
                    leaderboardTab: 'diamond',
                    
                    // Profile
                    myTrades: [],
                    editingName: false,
                    tempName: '',

                    // Share
                    showShareModal: false,
                    shareType: '', // card, leaderboard, profile
                    shareData: null,
                    generatedImage: null
                }
            },
            computed: {
                currentCard() {
                    return this.cards[0] || {};
                },
                totalLikes() {
                    return this.myTrades.reduce((acc, curr) => acc + (curr.likes || 0), 0);
                }
            },
            async mounted() {
                // Check Session
                const { data } = await _supabase.auth.getSession();
                if (data.session) {
                    this.session = data.session;
                    this.user = data.session.user;
                    await this.loadProfile();
                    this.changeView('swipe');
                }
                
                // Auth Listener
                _supabase.auth.onAuthStateChange((event, session) => {
                    this.session = session;
                    this.user = session?.user;
                    if (session) {
                        this.loadProfile();
                        if (this.currentView === 'auth') this.changeView('swipe');
                    } else {
                        this.currentView = 'auth';
                    }
                });
            },
            methods: {
                // --- NAVIGATION ---
                changeView(view) {
                    this.currentView = view;
                    if (view === 'swipe') this.fetchCards();
                    if (view === 'leaderboard') this.fetchLeaderboard();
                    if (view === 'profile') this.fetchMyHistory();
                    this.swipeAnimation = '';
                },
                formatDate(dateStr) {
                    return new Date(dateStr).toLocaleDateString();
                },

                // --- AUTH ---
                async handleAuth() {
                    this.loading = true;
                    this.authMsg = '';
                    try {
                        if (this.isSignUp) {
                            const { error } = await _supabase.auth.signUp({ email: this.authEmail, password: this.authPass });
                            if (error) throw error;
                            // Auto login happens, but let's inform
                            this.authMsg = "Account created! Logging in...";
                        } else {
                            const { error } = await _supabase.auth.signInWithPassword({ email: this.authEmail, password: this.authPass });
                            if (error) throw error;
                        }
                    } catch (e) {
                        this.authMsg = e.message;
                    } finally {
                        this.loading = false;
                    }
                },
                async handleSignOut() {
                    await _supabase.auth.signOut();
                },

                // --- PROFILE ---
                async loadProfile() {
                    if (!this.user) return;
                    let { data } = await _supabase.from('profiles').select('*').eq('id', this.user.id).single();
                    // Fallback if trigger failed (rare)
                    if (!data) {
                        const newProfile = { id: this.user.id, username: 'Trader_' + this.user.id.substring(0,4) };
                        await _supabase.from('profiles').insert(newProfile);
                        data = newProfile;
                    }
                    this.profile = data;
                    if (!this.profile.avatar_url) this.profile.avatar_url = `https://api.dicebear.com/7.x/micah/svg?seed=${this.user.id}`;
                },
                async randomizeAvatar() {
                    const seed = Math.random().toString(36).substring(7);
                    const url = `https://api.dicebear.com/7.x/micah/svg?seed=${seed}`;
                    this.profile.avatar_url = url;
                    await _supabase.from('profiles').update({ avatar_url: url }).eq('id', this.user.id);
                },
                toggleEditName() {
                    if (this.editingName) {
                        // Save
                        _supabase.from('profiles').update({ username: this.tempName }).eq('id', this.user.id).then(() => {
                            this.profile.username = this.tempName;
                        });
                    } else {
                        this.tempName = this.profile.username;
                    }
                    this.editingName = !this.editingName;
                },
                async fetchMyHistory() {
                    const { data } = await _supabase.from('trades').select('*').eq('user_id', this.user.id).order('created_at', { ascending: false });
                    this.myTrades = data || [];
                },
                async deleteTrade(id) {
                    if(confirm("Delete this trade?")) {
                        await _supabase.from('trades').delete().eq('id', id);
                        this.fetchMyHistory();
                    }
                },

                // --- SWIPE LOGIC ---
                async fetchCards() {
                    this.loadingCards = true;
                    try {
                        // Get IDs I already swiped
                        const { data: mySwipes } = await _supabase.from('swipes').select('trade_id').eq('user_id', this.user.id);
                        const swipedIds = mySwipes ? mySwipes.map(s => s.trade_id) : [];
                        
                        // Fetch trades NOT created by me AND NOT swiped by me
                        // Note: Supabase postgREST doesn't support "not in" easily with array, doing client side filter for simplicity in v1
                        const { data, error } = await _supabase
                            .from('trades')
                            .select('*, profiles(username, avatar_url)')
                            .neq('user_id', this.user.id)
                            .order('created_at', { ascending: false })
                            .limit(50);
                            
                        if (data) {
                            this.cards = data.filter(trade => !swipedIds.includes(trade.id));
                        }
                    } catch(e) { console.error(e) }
                    this.loadingCards = false;
                },
                async swipe(direction) {
                    if (!this.currentCard || !this.currentCard.id) return;
                    
                    const tradeId = this.currentCard.id;
                    const card = this.currentCard;

                    // 1. Animation
                    this.swipeAnimation = direction === 'LIKE' ? 'slide-out-right' : 'slide-out-left';

                    // 2. Data Update (Optimistic UI)
                    setTimeout(() => {
                        this.cards.shift();
                        this.swipeAnimation = '';
                    }, 300);

                    // 3. Backend Update
                    try {
                        await _supabase.from('swipes').insert({
                            user_id: this.user.id,
                            trade_id: tradeId,
                            direction: direction
                        });
                        
                        // Increment counters (Simple update, ideal world use RPC)
                        const updateField = direction === 'LIKE' ? { likes: card.likes + 1 } : { dislikes: card.dislikes + 1 };
                        await _supabase.from('trades').update(updateField).eq('id', tradeId);
                    } catch (e) {
                        console.error("Swipe sync error", e);
                    }
                },

                // --- POST TRADE ---
                async submitTrade() {
                    if (!this.form.ticker || !this.form.price) {
                        this.postError = "Please fill all fields.";
                        return;
                    }
                    this.isPosting = true;
                    this.postError = "";

                    // 1. Verify Price
                    let verified = false;
                    try {
                        const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${this.form.ticker}&token=${FINNHUB_KEY}`);
                        const data = await res.json();
                        // Check if current price (c) is within 5% of user price
                        if (data.c) {
                            const diff = Math.abs(data.c - this.form.price);
                            const percentDiff = (diff / data.c) * 100;
                            if (percentDiff < 5) verified = true;
                        }
                    } catch (e) {
                        console.log("API Error, skipping verify", e);
                    }

                    // 2. Insert
                    const { error } = await _supabase.from('trades').insert({
                        user_id: this.user.id,
                        ticker: this.form.ticker,
                        price: this.form.price,
                        shares: this.form.shares,
                        type: this.form.type,
                        verified: verified
                    });

                    this.isPosting = false;
                    if (error) {
                        this.postError = error.message;
                    } else {
                        // Reset and go home
                        this.form = { ticker: '', price: null, shares: null, type: 'BUY' };
                        this.changeView('swipe');
                        alert("Trade Posted!");
                    }
                },

                // --- LEADERBOARD ---
                async fetchLeaderboard() {
                    // Fetch top 20 by likes or dislikes
                    const sortField = this.leaderboardTab === 'diamond' ? 'likes' : 'dislikes';
                    const { data } = await _supabase
                        .from('trades')
                        .select('*, profiles(username)')
                        .order(sortField, { ascending: false })
                        .limit(20);
                    
                    if (this.leaderboardTab === 'diamond') this.leaderboard.diamond = data || [];
                    else this.leaderboard.paper = data || [];
                },

                // --- SHARE ---
                prepareShare(data, type) {
                    this.shareType = type;
                    this.shareData = data; // For card view
                    this.showShareModal = true;
                    this.generatedImage = null;

                    // Generate QR
                    setTimeout(() => {
                        document.getElementById("qrcode").innerHTML = "";
                        new QRCode(document.getElementById("qrcode"), {
                            text: window.location.href,
                            width: 60,
                            height: 60
                        });
                        
                        // Wait for QR render then capture
                        setTimeout(this.generateImage, 500);
                    }, 100);
                },
                generateImage() {
                    const el = document.getElementById('share-capture');
                    html2canvas(el, {
                        backgroundColor: '#0f172a',
                        useCORS: true, // Critical for avatars
                        scale: 2 // High res
                    }).then(canvas => {
                        this.generatedImage = canvas.toDataURL("image/png");
                    });
                },
                closeShare() {
                    this.showShareModal = false;
                    this.generatedImage = null;
                }
            }
        });
        
        app.mount('#app');
    </script>
</body>
</html>
